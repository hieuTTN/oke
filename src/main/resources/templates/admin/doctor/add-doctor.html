<!DOCTYPE html>
<html lang="en">

<head>
    <title>Doctors</title>
    <div th:insert="admin/template/menu :: libs"></div>
</head>

<body>
<div class="main-wrapper">
    <div th:insert="admin/template/menu :: headeradmin"></div>
    <div th:insert="admin/template/menu :: menu"></div>
    <div class="page-wrapper">
        <div class="content">
            <div class="row">
                <div class="col-lg-8 offset-lg-2">
                    <h4 class="page-title">Add Doctor</h4>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-8 offset-lg-2">
                    <form class="register-form" id="register-form" method="post">
                        <div class="row">
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label>Name <span class="text-danger">*</span></label>
                                    <input class="form-control" type="text" id="name" placeholder="Your name"
                                           name="name">
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label>Email <span class="text-danger">*</span></label>
                                    <input class="form-control" type="email" name="email" id="email"
                                           placeholder="Your email">
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label>Password</label>
                                    <input class="form-control" name="password" type="password" id="password"
                                           placeholder="Password">
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label>Confirm Password</label>
                                    <input class="form-control" type="password" name="re-pass" id="re-pass"
                                           placeholder="Re-Password">
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <div>
                                        <label>Date of Birth</label>
                                        <input type="date" class="form-control" id="dob" name="dob">
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label>Phone </label>
                                    <input class="form-control" type="text" id="phone">
                                </div>
                            </div>

                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label for="gender">Gender</label><br>
                                    <select id="gender" name="gender">
                                        <option th:each="gender : ${T(com.example.hospital_management.statics.Gender).values()}"
                                                th:value="${gender}"
                                                th:text="${#strings.capitalize(gender.toString().toLowerCase())}">
                                        </option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-sm-6">
                                <label for="speciality" class="form-label">Chuyên khoa</label>
                                <select class="form-control" id="speciality" multiple="multiple" name="speciality"
                                        required>
                                    <option th:each="speciality : ${listAllSpecialities}" th:value="${speciality.id}"
                                            th:text="${speciality.name}">Backend
                                    </option>
                                </select>
                            </div>

                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label for="doctorLevel">Doctor Level</label><br>
                                    <select id="doctorLevel" name="doctorLevel">
                                        <option th:each="level : ${T(com.example.hospital_management.statics.DoctorLevel).values()}"
                                                th:value="${level}"
                                                th:text="${#strings.capitalize(level.toString().toLowerCase())}">
                                        </option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-sm-12">
                                <div class="row">
                                    <div class="col-sm-12">
                                        <div class="form-group">
                                            <label>Address</label>
                                            <input type="text" class="form-control " id="address">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">

                        </div>
                        <div class="form-group">
                            <label>Short Biography</label>
                            <textarea class="form-control" rows="3" cols="30" id="introduce"></textarea>
                        </div>

                        <div class="mt-30">
                            <div class="lh-1 text-16 text-light-1">Images</div>
                            <div class="row x-gap-20 y-gap-20 pt-15">
                                <div class="col-auto">
                                    <div class="w-200">
                                        <div id="avatar-doctor"
                                             class="d-flex ratio ratio-1:1">

                                            <button class="btn-upload-image flex-center flex-column text-center bg-blue-2 h-full w-1/1 absolute rounded-4 border-type-1">
                                                <div class="icon-upload-file text-40 text-blue-1 mb-10"></div>
<!--                                                <div class="text-blue-1 fw-500">Upload-->
<!--                                                    Images-->
<!--                                                </div>-->
                                            </button>
                                        </div>
                                        <div class="text-center mt-10 text-14 text-light-1">
                                            <input type="file" id="fileInput"
                                            >
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                        <div class="m-t-20 text-center">
                            <button class="btn btn-primary submit-btn" type="submit" name="signup" id="signup">Create
                                Doctor
                            </button>
                        </div>
                    </form>

                </div>
            </div>
        </div>
        <div class="notification-box">
            <div class="msg-sidebar notifications msg-noti">
                <div class="topnav-dropdown-header">
                    <span>Messages</span>
                </div>
                <div class="drop-scroll msg-list-scroll" id="msg_list">
                    <ul class="list-box">
                        <li>
                            <a href="../chat.html">
                                <div class="list-item">
                                    <div class="list-left">
                                        <span class="avatar">R</span>
                                    </div>
                                    <div class="list-body">
                                        <span class="message-author">Richard Miles </span>
                                        <span class="message-time">12:28 AM</span>
                                        <div class="clearfix"></div>
                                        <span class="message-content">Lorem ipsum dolor sit amet, consectetur adipiscing</span>
                                    </div>
                                </div>
                            </a>
                        </li>
                        <li>
                            <a href="../chat.html">
                                <div class="list-item new-message">
                                    <div class="list-left">
                                        <span class="avatar">J</span>
                                    </div>
                                    <div class="list-body">
                                        <span class="message-author">John Doe</span>
                                        <span class="message-time">1 Aug</span>
                                        <div class="clearfix"></div>
                                        <span class="message-content">Lorem ipsum dolor sit amet, consectetur adipiscing</span>
                                    </div>
                                </div>
                            </a>
                        </li>
                        <li>
                            <a href="../chat.html">
                                <div class="list-item">
                                    <div class="list-left">
                                        <span class="avatar">T</span>
                                    </div>
                                    <div class="list-body">
                                        <span class="message-author"> Tarah Shropshire </span>
                                        <span class="message-time">12:28 AM</span>
                                        <div class="clearfix"></div>
                                        <span class="message-content">Lorem ipsum dolor sit amet, consectetur adipiscing</span>
                                    </div>
                                </div>
                            </a>
                        </li>
                        <li>
                            <a href="../chat.html">
                                <div class="list-item">
                                    <div class="list-left">
                                        <span class="avatar">M</span>
                                    </div>
                                    <div class="list-body">
                                        <span class="message-author">Mike Litorus</span>
                                        <span class="message-time">12:28 AM</span>
                                        <div class="clearfix"></div>
                                        <span class="message-content">Lorem ipsum dolor sit amet, consectetur adipiscing</span>
                                    </div>
                                </div>
                            </a>
                        </li>
                        <li>
                            <a href="../chat.html">
                                <div class="list-item">
                                    <div class="list-left">
                                        <span class="avatar">C</span>
                                    </div>
                                    <div class="list-body">
                                        <span class="message-author"> Catherine Manseau </span>
                                        <span class="message-time">12:28 AM</span>
                                        <div class="clearfix"></div>
                                        <span class="message-content">Lorem ipsum dolor sit amet, consectetur adipiscing</span>
                                    </div>
                                </div>
                            </a>
                        </li>
                        <li>
                            <a href="../chat.html">
                                <div class="list-item">
                                    <div class="list-left">
                                        <span class="avatar">D</span>
                                    </div>
                                    <div class="list-body">
                                        <span class="message-author"> Domenic Houston </span>
                                        <span class="message-time">12:28 AM</span>
                                        <div class="clearfix"></div>
                                        <span class="message-content">Lorem ipsum dolor sit amet, consectetur adipiscing</span>
                                    </div>
                                </div>
                            </a>
                        </li>
                        <li>
                            <a href="../chat.html">
                                <div class="list-item">
                                    <div class="list-left">
                                        <span class="avatar">B</span>
                                    </div>
                                    <div class="list-body">
                                        <span class="message-author"> Buster Wigton </span>
                                        <span class="message-time">12:28 AM</span>
                                        <div class="clearfix"></div>
                                        <span class="message-content">Lorem ipsum dolor sit amet, consectetur adipiscing</span>
                                    </div>
                                </div>
                            </a>
                        </li>
                        <li>
                            <a href="../chat.html">
                                <div class="list-item">
                                    <div class="list-left">
                                        <span class="avatar">R</span>
                                    </div>
                                    <div class="list-body">
                                        <span class="message-author"> Rolland Webber </span>
                                        <span class="message-time">12:28 AM</span>
                                        <div class="clearfix"></div>
                                        <span class="message-content">Lorem ipsum dolor sit amet, consectetur adipiscing</span>
                                    </div>
                                </div>
                            </a>
                        </li>
                        <li>
                            <a href="../chat.html">
                                <div class="list-item">
                                    <div class="list-left">
                                        <span class="avatar">C</span>
                                    </div>
                                    <div class="list-body">
                                        <span class="message-author"> Claire Mapes </span>
                                        <span class="message-time">12:28 AM</span>
                                        <div class="clearfix"></div>
                                        <span class="message-content">Lorem ipsum dolor sit amet, consectetur adipiscing</span>
                                    </div>
                                </div>
                            </a>
                        </li>
                        <li>
                            <a href="../chat.html">
                                <div class="list-item">
                                    <div class="list-left">
                                        <span class="avatar">M</span>
                                    </div>
                                    <div class="list-body">
                                        <span class="message-author">Melita Faucher</span>
                                        <span class="message-time">12:28 AM</span>
                                        <div class="clearfix"></div>
                                        <span class="message-content">Lorem ipsum dolor sit amet, consectetur adipiscing</span>
                                    </div>
                                </div>
                            </a>
                        </li>
                        <li>
                            <a href="../chat.html">
                                <div class="list-item">
                                    <div class="list-left">
                                        <span class="avatar">J</span>
                                    </div>
                                    <div class="list-body">
                                        <span class="message-author">Jeffery Lalor</span>
                                        <span class="message-time">12:28 AM</span>
                                        <div class="clearfix"></div>
                                        <span class="message-content">Lorem ipsum dolor sit amet, consectetur adipiscing</span>
                                    </div>
                                </div>
                            </a>
                        </li>
                        <li>
                            <a href="../chat.html">
                                <div class="list-item">
                                    <div class="list-left">
                                        <span class="avatar">L</span>
                                    </div>
                                    <div class="list-body">
                                        <span class="message-author">Loren Gatlin</span>
                                        <span class="message-time">12:28 AM</span>
                                        <div class="clearfix"></div>
                                        <span class="message-content">Lorem ipsum dolor sit amet, consectetur adipiscing</span>
                                    </div>
                                </div>
                            </a>
                        </li>
                        <li>
                            <a href="../chat.html">
                                <div class="list-item">
                                    <div class="list-left">
                                        <span class="avatar">T</span>
                                    </div>
                                    <div class="list-body">
                                        <span class="message-author">Tarah Shropshire</span>
                                        <span class="message-time">12:28 AM</span>
                                        <div class="clearfix"></div>
                                        <span class="message-content">Lorem ipsum dolor sit amet, consectetur adipiscing</span>
                                    </div>
                                </div>
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="topnav-dropdown-footer">
                    <a href="../chat.html">See all messages</a>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="sidebar-overlay" data-reff=""></div>


</body>


<!-- jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"
        integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
<!-- axios -->
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>


<!--  toastr.js-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-storage.js"></script>


<script th:inline="javascript">

    // Cấu hình thông tin Firebase của bạn
    let firebaseConfig = {
        apiKey: "AIzaSyCPfxKN6sz8b7ndgoENeNqZ3FnwVjKTCZM",
        authDomain: "hospital-management-syst-24909.firebaseapp.com",
        projectId: "hospital-management-syst-24909",
        storageBucket: "hospital-management-syst-24909.appspot.com",
        messagingSenderId: "516287285398",
        appId: "1:516287285398:web:19ce4b60a5e6f83ea45ab7",
        measurementId: "G-8PYB0H7K7R",
    };

    // Khởi tạo Firebase
    firebase.initializeApp(firebaseConfig);

    // Lấy tham chiếu đến Firebase Storage bucket
    let storage = firebase.storage();
    let storageRef = storage.ref();

    $(document).ready(function () {

        //open chosen image form
        // $('.btn-upload-image').click(() => {
        //     $('#fileInput').click();
        // });

        // show image
        let chosenFile = null;
        $('#fileInput').change(event => {
            const maxSizeInBytes = 5242880;
            const tempFiles = event.target.files;
            if (!tempFiles || tempFiles.length === 0) {
                return;
            }
            chosenFile = tempFiles[0];
            if (chosenFile && chosenFile.size > maxSizeInBytes) {
                alert("File size exceeded the allowed limit (5MB)!");
                this.value = '';
                return;
            }
            const imageBlob = new Blob([chosenFile], {type: chosenFile.type});
            const imageUrl = URL.createObjectURL(imageBlob);
            $('#avatar-doctor .btn-upload-image').empty();
            let showImageHtml = `<img alt='Avatar' style="width: 200px; height: 100%; object-fit: cover" src='${imageUrl}'/>`;
            $('#avatar-doctor .btn-upload-image').append(showImageHtml)
        });

        // Kích hoạt select2
        const doctor_speciality = $("#speciality");
        doctor_speciality.select2({
            placeholder: "Chọn chuyên khoa",
        });

        toastr.options = {
            positionClass: 'toast-center',
            timeOut: 0
        }
        $(".register-form").validate({
            onfocusout: false,
            onkeyup: false,
            onclick: false,
            errorPlacement: function (error, element) {
                error.addClass("error-message");
                error.insertAfter(element.parent());
            },
            rules: {
                "email": {
                    required: true,
                    email: true
                },
                "password": {
                    required: true,
                },
                "re-pass": {
                    required: true,
                    equalTo: "#password"
                }
            },
            messages: {
                "email": {
                    required: "Enter your email",
                    email: "Incorrect email format"
                },
                "password": {
                    required: "Enter your password"
                },
                "re-pass": {
                    required: "Repeat your password",
                    equalTo: "Re-password incorrect"
                }
            }

        })

        async function uploadImageAndCreateDoctor() {
            let name = $('#name').val();
            let email = $('#email').val();
            let phone = $('#phone').val();
            let password = $('#password').val();
            let address = $('#address').val();
            let introduce = $('#introduce').val();
            let dob = $('#dob').val();
            let gender = $('#gender').val();
            let doctorLevel = $('#doctorLevel').val();
            let selectedSpecialities = [];
            $('#speciality option:selected').each(function () {
                selectedSpecialities.push($(this).val());
            })

            let newDoctor = {
                name: name,
                email: email,
                phone: phone,
                password: password,
                address: address,
                introduce: introduce,
                dob: dob,
                gender: gender,
                avatar: "",
                specialityIds: selectedSpecialities,
                doctorLevel: doctorLevel
            };

            console.log(newDoctor);
            // Upload the image first
            if (chosenFile != null) {
                newDoctor.avatar = await uploadImage(chosenFile);
                createDoctor(newDoctor);
            } else {
                createDoctor(newDoctor);
            }
        }

        function createDoctor(newDoctor) {
            $.ajax({
                type: 'POST',
                url: '/api/v1/authentication/signupDoctor',
                contentType: "application/json",
                data: JSON.stringify(newDoctor),
                success: function (response) {
                    toastr.success("Create doctor success!");
                    setTimeout(function () {
                        $('#submitBtn').prop('disabled', false);
                        window.location.reload();
                    }, 800)
                },
                error: function () {
                    toastr.warning("Create doctor not success!");
                }
            });
        }

        async function uploadImage(chosenFile) {
            try {
                let imageName = chosenFile.name;
                let imageRef = storageRef.child("images/" + imageName);
                let snapshort = await imageRef.put(chosenFile);
                return await snapshort.ref.getDownloadURL();
            } catch (error) {
                throw error;
            }
        }

        $('#signup').click(event => {
            console.log("click");
            event.preventDefault();
            let isValidForm = $("#register-form").valid();
            if (!isValidForm) return;
            $('#signup').prop('disabled', true);
            uploadImageAndCreateDoctor();
        })


        // $('#signup').click(function (event) {
        //     event.preventDefault();
        //
        //     var isValidForm = $('.register-form').valid();
        //     if (!isValidForm) return;
        //
        //     var name = $('#name').val();
        //     var email = $('#email').val();
        //     var phone = $('#phone').val();
        //     var password = $('#password').val();
        //     var address = $('#address').val();
        //     var introduce = $('#introduce').val();
        //     var dob = $('#dob').val();
        //     var gender = $('#gender').val();
        //     var avatar = $('#avatar').val();
        //     var doctorLevel = $('#doctorLevel').val();
        //     var selectedSpecialities = [];
        //     $('#speciality option:selected').each(function () {
        //         selectedSpecialities.push($(this).val());
        //     })
        //
        //     var formData = {
        //         name: name,
        //         email: email,
        //         phone: phone,
        //         password: password,
        //         address: address,
        //         introduce: introduce,
        //         dob: dob,
        //         gender: gender,
        //         avatar: avatar,
        //         specialityIds: selectedSpecialities,
        //         doctorLevel: doctorLevel
        //
        //     };
        //
        //     $.ajax({
        //         url: '/api/v1/authentication/signupDoctor',
        //         type: 'POST',
        //         contentType: "application/json; charset=utf-8",
        //         data: JSON.stringify(formData),
        //         success: function (response) {
        //             console.log(response);
        //             localStorage.setItem('formData', JSON.stringify(formData));
        //             toastr.success('Đăng ký thành công!');
        //             window.location.href = 'http://localhost:8080/admin/doctors';
        //         },
        //         error: function (data) {
        //             toastr.error("Đăng ký không thành công!");
        //         }
        //     });
        // })
    })
</script>

<!-- add-doctor24:06-->
</html>
